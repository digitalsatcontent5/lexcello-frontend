<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6EV4Y6N8M5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-6EV4Y6N8M5');
</script>
<link rel="icon" type="image/png" href="/favicon.png">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lexcello LNAT Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1a365d;
            --primary-hover: #2d4a66;
            --secondary-color: #2b6cb0;
            --accent-gold: #d69e2e;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --bg-light: #f7fafc;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #e53e3e;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
            padding-top: 80px;
        }
        
        /* Navigation */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color) !important;
            letter-spacing: -1px;
        }
        
        .nav-link {
            font-weight: 500;
            color: var(--text-dark) !important;
            margin: 0 0.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .user-info .dropdown-toggle {
            cursor: pointer;
        }
        
        /* Dashboard Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 60px 0 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-10px, -10px) rotate(5deg); }
        }
        
        .welcome-text {
            position: relative;
            z-index: 2;
        }

        .welcome-text h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .welcome-text p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 30px;
            position: relative;
            z-index: 2;
        }
        
        .progress-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .progress-card:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-3px);
        }
        
        .progress-number {
            font-size: 2.5rem;
            font-weight: 800;
            display: block;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }
        
        .progress-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .progress-trend {
            font-size: 0.8rem;
            margin-top: 5px;
            opacity: 0.8;
        }

        .trend-up {
            color: #90EE90;
        }

        .trend-down {
            color: #FFB6C1;
        }
        
        /* Content Sections */
        .content-section {
            margin-bottom: 40px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn-section-action {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        /* Enhanced Test Cards */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 25px;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .test-card:hover::before {
            transform: scaleX(1);
        }
        
        .test-card.completed {
            border-left-color: var(--success-color);
        }
        
        .test-card.available {
            border-left-color: var(--secondary-color);
        }
        
        .test-card.locked {
            border-left-color: #e2e8f0;
            opacity: 0.7;
        }

        .test-card.premium-required {
            border-left-color: var(--accent-gold);
            background: linear-gradient(135deg, #fffaf0, #ffffff);
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .test-number {
            background: var(--secondary-color);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .test-number.completed {
            background: var(--success-color);
        }

        .test-number.premium {
            background: var(--accent-gold);
            color: var(--primary-color);
        }

        .test-number.locked {
            background: #e2e8f0;
            color: #a0aec0;
        }
        
        .test-info {
            flex: 1;
            margin-left: 15px;
        }
        
        .test-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0 0 8px 0;
        }
        
        .test-status {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-available {
            background: #bee3f8;
            color: #2b6cb0;
        }
        
        .status-locked {
            background: #e2e8f0;
            color: #718096;
        }

        .status-premium-required {
            background: #fef5e7;
            color: #744210;
        }

        .premium-badge {
            background: var(--accent-gold);
            color: var(--primary-color);
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 700;
            margin-left: 8px;
        }

        .test-score-display {
            text-align: right;
        }

        .test-score {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--success-color);
            line-height: 1;
        }

        .test-score-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .test-attempts {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .test-details {
            margin: 20px 0;
        }
        
        .test-detail {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .detail-label {
            color: var(--text-light);
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .progress-bar-mini {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            border-radius: 3px;
            transition: width 0.8s ease;
        }
        
        .test-actions {
            margin-top: 25px;
            display: flex;
            gap: 10px;
        }
        
        .btn-test-action {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-start {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-start:hover {
            background: var(--primary-hover);
        }
        
        .btn-review {
            background: var(--success-color);
            color: white;
        }
        
        .btn-review:hover {
            background: #38a169;
        }

        .btn-retake {
            background: var(--warning-color);
            color: white;
        }

        .btn-retake:hover {
            background: #dd6b20;
        }
        
        .btn-locked {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .btn-upgrade {
            background: var(--accent-gold);
            color: var(--primary-color);
        }

        .btn-upgrade:hover {
            background: #b7791f;
            color: white;
        }

        /* Subscription Alert */
        .subscription-alert {
            background: linear-gradient(135deg, var(--accent-gold), #f7c41f);
            color: var(--primary-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: none;
        }

        .subscription-alert h5 {
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subscription-alert .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .subscription-alert .btn:hover {
            background: var(--primary-hover);
        }
        
        /* Performance Chart */
        .performance-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
        }
        
        .chart-placeholder {
            text-align: center;
            color: var(--text-light);
        }

        .performance-chart-real {
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .chart-line {
            stroke: var(--secondary-color);
            stroke-width: 3;
            fill: none;
        }

        .chart-area {
            fill: url(#gradient);
            opacity: 0.3;
        }

        .chart-point {
            fill: var(--secondary-color);
            stroke: white;
            stroke-width: 2;
            r: 5;
            cursor: pointer;
        }

        .chart-point:hover {
            r: 7;
            fill: var(--primary-color);
        }

        .chart-grid {
            stroke: #e2e8f0;
            stroke-width: 1;
        }

        .chart-label {
            font-size: 12px;
            fill: var(--text-light);
        }
        
        /* Study Recommendations */
        .recommendation-card {
            background: linear-gradient(135deg, var(--accent-gold), #f7c41f);
            color: var(--primary-color);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .recommendation-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        .recommendation-card h5 {
            font-weight: 700;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
        }

        .recommendation-content {
            position: relative;
            z-index: 2;
        }
        
        .recommendation-card .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .recommendation-card .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        /* Enhanced Recent Activity */
        .activity-item {
            display: flex;
            align-items: center;
            padding: 18px;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .activity-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
        }
        
        .activity-completed {
            background: var(--success-color);
            color: white;
        }
        
        .activity-started {
            background: var(--secondary-color);
            color: white;
        }

        .activity-improvement {
            background: var(--accent-gold);
            color: var(--primary-color);
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            color: var(--text-dark);
            margin: 0 0 5px 0;
        }
        
        .activity-time {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .activity-score {
            font-weight: 700;
            color: var(--success-color);
            margin-left: 15px;
            font-size: 1.1rem;
        }

        /* Study Statistics */
        .stats-mini-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-mini-card {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-mini-card:hover {
            border-color: var(--secondary-color);
            background: white;
        }

        .stat-mini-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-mini-label {
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Achievement Badges */
        .achievements-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .achievement-badge {
            background: var(--success-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .achievement-badge.gold {
            background: var(--accent-gold);
            color: var(--primary-color);
        }

        .achievement-badge.silver {
            background: #a0aec0;
            color: white;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            border-radius: 4px;
            margin: 8px 0;
        }

        .skeleton-title {
            height: 24px;
            border-radius: 6px;
            margin: 12px 0;
        }
        
        /* Footer */
        .footer {
            background: white;
            padding: 40px 0 20px;
            margin-top: 60px;
            border-top: 1px solid #e2e8f0;
        }
        
        .footer-links a {
            color: var(--text-light);
            text-decoration: none;
            margin-right: 20px;
        }
        
        .footer-links a:hover {
            color: var(--primary-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .welcome-text h1 {
                font-size: 2rem;
            }
            
            .progress-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .tests-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .stats-mini-grid {
                grid-template-columns: 1fr;
            }

            .test-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Lexcello</a>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <span class="user-name" id="userName">Student</span>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#settings"><i class="fas fa-cog me-2"></i>Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="signOut()"><i class="fas fa-sign-out-alt me-2"></i>Sign Out</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <section class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <div class="welcome-text">
                        <h1 id="welcomeMessage">Welcome back!</h1>
                        <p id="welcomeSubtext">Continue your LNAT preparation journey. You're making great progress toward your law school goals.</p>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="progress-summary">
                        <div class="progress-card">
                            <span class="progress-number" id="testsCompleted">0</span>
                            <div class="progress-label">Tests Completed</div>
                            <div class="progress-trend" id="testsCompletedTrend"></div>
                        </div>
                        <div class="progress-card">
                            <span class="progress-number" id="averageScore">0%</span>
                            <div class="progress-label">Average Score</div>
                            <div class="progress-trend" id="averageScoreTrend"></div>
                        </div>
                        <div class="progress-card">
                            <span class="progress-number" id="bestScore">0%</span>
                            <div class="progress-label">Best Score</div>
                            <div class="progress-trend" id="bestScoreTrend"></div>
                        </div>
                        <div class="progress-card">
                            <span class="progress-number" id="studyStreak">0</span>
                            <div class="progress-label">Day Streak</div>
                            <div class="progress-trend" id="studyStreakTrend"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Dashboard Content -->
    <div class="container">
        <!-- Subscription Alert (shown for non-premium users) -->
        <div class="alert subscription-alert" id="subscriptionAlert" style="display: none;">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h5><i class="fas fa-star me-2"></i>Unlock Your Full LNAT Potential</h5>
                    <p class="mb-0">Get access to all 10 practice tests with detailed analytics, explanations, and performance tracking. Join thousands of successful LNAT candidates.</p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <button class="btn" onclick="upgradeToPremium()">
                        <i class="fas fa-crown me-2"></i>Upgrade to Premium
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Practice Tests Section -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-clipboard-list me-2"></i>Your Practice Tests
                        </h2>
                        <div class="section-actions">
                            <a href="#" class="btn btn-outline-primary btn-section-action" onclick="showAllTests()">
                                <i class="fas fa-list me-1"></i>View All
                            </a>
                        </div>
                    </div>
                    
                    <div id="testsContainer" class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading tests...</span>
                        </div>
                        <div class="mt-3">Loading your tests...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Performance Chart -->
                <div class="content-section">
                    <div class="performance-card">
                        <h3 class="section-title">
                            <i class="fas fa-chart-line me-2"></i>Performance Trend
                        </h3>
                        <div class="chart-container" id="performanceChartContainer">
                            <div class="chart-placeholder" id="performanceChart">
                                <i class="fas fa-chart-area fa-3x text-secondary mb-3"></i>
                                <div class="h5">Score Progress</div>
                                <div class="text-muted" id="progressText">Complete your first test to see progress</div>
                                <div class="mt-3" id="improvementBadge">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="content-section">
                    <div class="performance-card">
                        <h4><i class="fas fa-trophy me-2"></i>Achievements</h4>
                        <div class="achievements-container" id="achievementsContainer">
                            <div class="achievement-badge">
                                <i class="fas fa-star"></i>
                                Welcome!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="content-section">
                    <h3 class="section-title">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h3>
                    
                    <div id="recentActivity">
                        <div class="activity-item">
                            <div class="activity-icon activity-started">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-info">
                                <div class="activity-title">Joined Lexcello</div>
                                <div class="activity-time" id="joinDate">Welcome to your LNAT prep!</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="content-section">
                    <div class="performance-card">
                        <h4><i class="fas fa-chart-bar me-2"></i>Quick Stats</h4>
                        <div class="stats-mini-grid">
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="totalTime">0h</div>
                                <div class="stat-mini-label">Study Time</div>
                            </div>
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="accuracy">0%</div>
                                <div class="stat-mini-label">Accuracy</div>
                            </div>
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="improvement">+0%</div>
                                <div class="stat-mini-label">Improvement</div>
                            </div>
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="nextGoal">Test 1</div>
                                <div class="stat-mini-label">Next Goal</div>
                            </div>
                        </div>
                        <div class="test-detail">
                            <span class="detail-label">Account Status:</span>
                            <span class="detail-value" id="accountStatus">Loading...</span>
                        </div>
                        <div class="test-detail">
                            <span class="detail-label">Tests Available:</span>
                            <span class="detail-value" id="testsAvailable">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="text-center">
                <div class="footer-links mb-3">
                    <a href="index.html">Home</a>
                    <a href="about-lnat.html">About LNAT</a>
                    <a href="pricing.html">Pricing</a>
                    <a href="contact.html">Contact</a>
                    <a href="privacy-policy.html">Privacy Policy</a>
                    <a href="terms-of-service.html">Terms of Service</a>
                </div>
                <p class="text-muted">&copy; 2024 Lexcello. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration
        const API_BASE_URL = 'https://lexcello-backend.onrender.com/api';
        let currentUser = null;
        let userTestAttempts = [];
        let availableTests = {};
        let userSubscription = { isPaid: false, isDemo: true };
        
        // Authentication check and initialization
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                await checkAuthStatus();
                await checkSubscriptionStatus();
                await loadUserData();
                await loadTests();
                updateProgressStats();
                updateRecentActivity();
                generateAchievements();
                updateSubscriptionUI();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showLoadingError();
            }
        }

        // Function to check user subscription status
        async function checkSubscriptionStatus() {
            const token = localStorage.getItem('authToken');
            
            if (!token || !currentUser) {
                userSubscription = { isPaid: false, isDemo: true, subscriptionType: 'free' };
                return userSubscription;
            }

            try {
                // Use existing profile endpoint to get current subscription status
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    const subscriptionStatus = userData.subscriptionStatus || 'inactive';
                    const isPaid = subscriptionStatus === 'premium' || subscriptionStatus === 'active';
                    
                    // Check if subscription has expired
                    let isExpired = false;
                    if (userData.subscriptionExpiresAt) {
                        const expirationDate = new Date(userData.subscriptionExpiresAt);
                        isExpired = expirationDate < new Date();
                    }
                    
                    userSubscription = {
                        isPaid: isPaid && !isExpired,
                        subscriptionStatus: subscriptionStatus,
                        subscriptionType: isPaid && !isExpired ? 'premium' : 'free',
                        expiresAt: userData.subscriptionExpiresAt,
                        isExpired: isExpired,
                        isDemo: false
                    };

                    // Update currentUser with latest subscription info
                    currentUser.subscriptionStatus = subscriptionStatus;
                    currentUser.subscriptionExpiresAt = userData.subscriptionExpiresAt;
                    
                } else {
                    userSubscription = { isPaid: false, isDemo: false, subscriptionType: 'free' };
                }
            } catch (error) {
                console.error('Subscription check failed:', error);
                userSubscription = { isPaid: false, isDemo: false, subscriptionType: 'free' };
            }

            return userSubscription;
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        currentUser = await response.json();
                        updateUserInfo();
                    } else {
                        // Token invalid, remove it
                        localStorage.removeItem('authToken');
                        currentUser = null;
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    currentUser = null;
                    window.location.href = 'login.html';
                }
            } else {
                // No token, redirect to login
                window.location.href = 'login.html';
            }
        }

        function updateUserInfo() {
            if (currentUser) {
                const userName = currentUser.name || currentUser.email || 'Student';
                const firstName = userName.split(' ')[0] || userName.split('@')[0] || 'Student';
                
                document.getElementById('userName').textContent = firstName;
                document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
                document.getElementById('welcomeMessage').textContent = `Welcome back, ${firstName}!`;
            }
        }

        function updateSubscriptionUI() {
            const subscriptionAlert = document.getElementById('subscriptionAlert');
            const accountStatus = document.getElementById('accountStatus');
            
            if (userSubscription.isPaid) {
                subscriptionAlert.style.display = 'none';
                accountStatus.innerHTML = '<span class="text-success">Premium Active</span>';
                
                // Update welcome message for premium users
                const welcomeSubtext = document.getElementById('welcomeSubtext');
                welcomeSubtext.textContent = 'You have premium access to all LNAT practice tests. Continue your preparation and track your progress.';
            } else {
                subscriptionAlert.style.display = 'block';
                accountStatus.innerHTML = '<span class="text-warning">Free Account</span>';
                
                // Update welcome message for free users
                const welcomeSubtext = document.getElementById('welcomeSubtext');
                welcomeSubtext.textContent = 'You have access to Practice Test 1. Upgrade to premium to unlock all 10 tests and advanced features.';
            }
        }
        
        // Load user test attempts and performance data
        async function loadUserData() {
            try {
                userTestAttempts = [];
                
                if (currentUser) {
                    // Try to fetch user's test attempts from API using existing endpoint
                    try {
                        const token = localStorage.getItem('authToken');
                        const response = await fetch(`${API_BASE_URL}/user/test-history`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // Convert test-history format to the format dashboard expects
                            userTestAttempts = (data.history || []).map(attempt => ({
                                test_id: attempt.testId,
                                score: attempt.percentage,
                                correct_answers: attempt.score,
                                total_questions: attempt.totalQuestions,
                                time_spent: attempt.timeSpent,
                                completed_at: attempt.completedAt,
                                user_answers: {},
                                flagged_questions: []
                            }));
                            console.log('Loaded user test attempts:', userTestAttempts);
                        }
                    } catch (error) {
                        console.log('Could not fetch user test attempts, checking localStorage');
                    }
                }

                // Also check localStorage for recent test results
                const recentResults = sessionStorage.getItem('testResults');
                if (recentResults) {
                    try {
                        const result = JSON.parse(recentResults);
                        if (result && result.score !== undefined) {
                            // Add to attempts if not already present
                            const existingAttempt = userTestAttempts.find(a => 
                                a.test_id === (result.test_id || 1) && 
                                Math.abs(new Date(a.completed_at) - new Date()) < 60000 // Within last minute
                            );
                            
                            if (!existingAttempt) {
                                userTestAttempts.push({
                                    test_id: result.test_id || 1,
                                    score: result.score || Math.round((result.correct_answers / result.total_questions) * 100),
                                    time_spent: result.time_spent || 0,
                                    correct_answers: result.correct_answers || 0,
                                    total_questions: result.total_questions || 42,
                                    completed_at: new Date().toISOString()
                                });
                                console.log('Added recent test result to attempts');
                            }
                        }
                    } catch (error) {
                        console.log('Could not parse recent test results');
                    }
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Load available tests with subscription checking
        async function loadTests() {
            try {
                console.log('Loading tests...');
                const testStatuses = await checkTestContent();
                availableTests = testStatuses;
                renderTestsWithSubscriptionCheck(testStatuses);
                updateTestsAvailableCount(testStatuses);
                
            } catch (error) {
                console.error('Error loading tests:', error);
                renderTestsFallback();
            }
        }
        
        // Check which tests actually have questions
        async function checkTestContent() {
            const testStatuses = {};
            
            for (let testId = 1; testId <= 10; testId++) {
                try {
                    const token = localStorage.getItem('authToken');
const response = await fetch(`${API_BASE_URL}/tests/${testId}/questions`, {
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    }
});
                    
                    if (response.ok) {
                        const data = await response.json();
                        let questionCount = 0;
                        
                        if (Array.isArray(data)) {
                            questionCount = data.length;
                        } else if (data.questions && Array.isArray(data.questions)) {
                            questionCount = data.questions.length;
                        } else if (data.message && data.message.includes('questions found')) {
                            const match = data.message.match(/(\d+)\s+questions?\s+found/i);
                            questionCount = match ? parseInt(match[1]) : 0;
                        } else if (data.count !== undefined) {
                            questionCount = data.count;
                        }
                        
                        testStatuses[testId] = {
                            hasContent: questionCount > 0,
                            questionCount: questionCount,
                            status: questionCount > 0 ? 'available' : 'empty'
                        };
                    } else {
                        testStatuses[testId] = {
                            hasContent: false,
                            questionCount: 0,
                            status: 'empty'
                        };
                    }
                } catch (error) {
                    testStatuses[testId] = {
                        hasContent: false,
                        questionCount: 0,
                        status: 'error'
                    };
                }
            }
            
            return testStatuses;
        }
        
        // Render tests with subscription-based access control
        function renderTestsWithSubscriptionCheck(testStatuses) {
            const container = document.getElementById('testsContainer');
            container.innerHTML = '<div class="tests-grid"></div>';
            const testsGrid = container.querySelector('.tests-grid');
            
            let testsHTML = '';
            
            // Render each test with subscription-based access control
            for (let testId = 1; testId <= 10; testId++) {
                const status = testStatuses[testId] || { hasContent: false, questionCount: 0, status: 'empty' };
                const userAttempts = userTestAttempts.filter(attempt => attempt.test_id === testId);
                const hasCompleted = userAttempts.length > 0;
                
                // Check if user has access to this test
                const hasAccess = testId === 1 || userSubscription.isPaid;
                const isPremiumTest = testId > 1;
                
                // Calculate best score
                let bestScore = 0;
                if (hasCompleted) {
                    const validScores = userAttempts.map(attempt => {
                        let score = attempt.score;
                        if (typeof score === 'string') {
                            score = score.replace('%', '');
                            score = parseFloat(score);
                        } else {
                            score = Number(score);
                        }
                        return isNaN(score) ? 0 : score;
                    });
                    bestScore = Math.max(...validScores);
                }
                
                const latestAttempt = hasCompleted ? userAttempts[userAttempts.length - 1] : null;
                
               // Show all tests 1-10, regardless of content availability
                if (testId <= 10) {
                    let cardClass, statusText, statusClass, actionButtons;
                    
                    if (!status.hasContent && testId > 1) {
                    // Test has no content - show Coming Soon
                    cardClass = 'locked';
                    statusText = 'Coming Soon';
                    statusClass = 'status-locked';
                    actionButtons = `
                        <button class="btn btn-test-action btn-locked" disabled>
                            <i class="fas fa-clock me-1"></i>Coming Soon
                        </button>
                    `;
                } else if (!hasAccess && isPremiumTest) {
                    // Premium test, user doesn't have access
                    cardClass = 'premium-required';
                    statusText = 'Premium Required';
                    statusClass = 'status-premium-required';
                    actionButtons = `
                        <button class="btn btn-test-action btn-upgrade" onclick="upgradeToPremium()">
                            <i class="fas fa-crown me-1"></i>Upgrade to Access
                        </button>
                    `;
                } else if (hasCompleted && hasAccess) {
                    // User has completed this test and has access
                    cardClass = 'completed';
                    statusText = `Completed (${Math.round(bestScore)}%)`;
                    statusClass = 'status-completed';
                    actionButtons = `
                        <button class="btn btn-test-action btn-review" onclick="viewTestResults(${testId})">
                            <i class="fas fa-chart-line me-1"></i>Review
                        </button>
                        <button class="btn btn-test-action btn-retake" onclick="startTest(${testId})">
                            <i class="fas fa-redo me-1"></i>Retake
                        </button>
                    `;
                } else if (status.hasContent && hasAccess) {
                    // Test available and user has access
                    cardClass = 'available';

                    // Calculate progress for this test
                        statusText = 'Ready to Start';
                    statusClass = 'status-available';
                    actionButtons = `
                        <button class="btn btn-test-action btn-start" onclick="startTest(${testId})">
                            <i class="fas fa-play me-1"></i>Start Test
                        </button>
                    `;
                } else {
                    // Test has no content
                    cardClass = 'locked';
                    statusText = 'Coming Soon';
                    statusClass = 'status-locked';
                    actionButtons = `
                        <button class="btn btn-test-action btn-locked" disabled>
                            <i class="fas fa-clock me-1"></i>Coming Soon
                        </button>
                    `;
                }
                    const progress = hasCompleted ? 100 : 0;
                    
                    // Premium badge for tests 2-10
                    const premiumBadge = isPremiumTest && !userSubscription.isPaid ? 
                        '<span class="premium-badge">PREMIUM</span>' : '';
                    
                    testsHTML += `
                        <div class="test-card ${cardClass}">
                            <div class="test-header">
                                <div class="test-number ${hasCompleted ? 'completed' : isPremiumTest && !userSubscription.isPaid ? 'premium' : status.hasContent ? '' : 'locked'}">${testId}</div>
                                <div class="test-info">
                                    <h4 class="test-title">Practice Test ${testId}${premiumBadge}</h4>
                                    <span class="test-status ${statusClass}">${statusText}</span>
                                </div>
                                ${hasCompleted ? `
                                    <div class="test-score-display">
                                        <div class="test-score">${Math.round(bestScore)}%</div>
                                        <div class="test-score-label">Best Score</div>
                                        <div class="test-attempts">${userAttempts.length} attempt${userAttempts.length > 1 ? 's' : ''}</div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="test-details">
                                <div class="test-detail">
                                    <span class="detail-label">Questions:</span>
                                    <span class="detail-value">${status.questionCount || 42}</span>
                                </div>
                                <div class="test-detail">
                                    <span class="detail-label">Time Limit:</span>
                                    <span class="detail-value">95 minutes</span>
                                </div>
                                <div class="test-detail">
                                    <span class="detail-label">Access:</span>
                                    <span class="detail-value">${hasAccess ? 'Available' : 'Premium Required'}</span>
                                </div>
                                ${hasCompleted && latestAttempt ? `
                                    <div class="test-detail">
                                        <span class="detail-label">Last Completed:</span>
                                        <span class="detail-value">${formatDate(latestAttempt.completed_at)}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: ${progress}%"></div>
                            </div>
                            <div class="test-actions">
                                ${actionButtons}
                            </div>
                        </div>
                    `;
                }
            }
            
            testsGrid.innerHTML = testsHTML;
            console.log(`Rendered tests with subscription checking`);
        }

        function updateTestsAvailableCount(testStatuses) {
            const totalWithContent = Object.values(testStatuses).filter(s => s.hasContent).length;
            const userAccessCount = userSubscription.isPaid ? totalWithContent : Math.min(1, totalWithContent);
            document.getElementById('testsAvailable').textContent = `${userAccessCount}${userSubscription.isPaid ? '' : ' (+ ' + (totalWithContent - userAccessCount) + ' premium)'}`;
        }
        
        // Fallback rendering
        function renderTestsFallback() {
            const container = document.getElementById('testsContainer');
            container.innerHTML = `
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Connection Issue:</strong> Using cached data. Some features may be limited.
                </div>
                <div class="tests-grid">
                    <div class="test-card available">
                        <div class="test-header">
                            <div class="test-number">1</div>
                            <div class="test-info">
                                <h4 class="test-title">Practice Test 1</h4>
                                <span class="test-status status-available">Available</span>
                            </div>
                        </div>
                        <div class="test-details">
                            <div class="test-detail">
                                <span class="detail-label">Questions:</span>
                                <span class="detail-value">42</span>
                            </div>
                            <div class="test-detail">
                                <span class="detail-label">Time Limit:</span>
                                <span class="detail-value">95 minutes</span>
                            </div>
                        </div>
                        <div class="test-actions">
                            <button class="btn btn-test-action btn-start" onclick="startTest(1)">
                                <i class="fas fa-play me-1"></i>Start Test
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Update progress statistics with proper number conversion
        function updateProgressStats() {
            const completedTests = userTestAttempts.length;
            const uniqueTests = [...new Set(userTestAttempts.map(a => a.test_id))].length;
            
            // Ensure scores are properly converted to numbers and filter invalid ones
            const validScores = userTestAttempts
                .map(attempt => {
                    let score = attempt.score;
                    // Handle different score formats
                    if (typeof score === 'string') {
                        score = score.replace('%', ''); // Remove % if present
                        score = parseFloat(score);
                    } else {
                        score = Number(score);
                    }
                    return isNaN(score) ? 0 : score;
                })
                .filter(score => score > 0);
            
            const totalScore = validScores.reduce((sum, score) => sum + score, 0);
            const averageScore = validScores.length > 0 ? Math.round(totalScore / validScores.length) : 0;
            const bestScore = validScores.length > 0 ? Math.max(...validScores) : 0;
            
            // Calculate improvement with validation
            let improvement = 0;
            if (validScores.length >= 2) {
                const firstScore = validScores[0];
                const latestScore = validScores[validScores.length - 1];
                if (firstScore > 0) {
                    improvement = Math.round(((latestScore - firstScore) / firstScore) * 100);
                }
            }

            // Calculate study streak (simplified)
            const studyStreak = Math.min(uniqueTests * 2, 14);
            
            // Animate progress numbers
            animateNumber('testsCompleted', uniqueTests);
            animateNumber('averageScore', averageScore, '%');
            animateNumber('bestScore', bestScore, '%');
            animateNumber('studyStreak', studyStreak);

            // Update trends
            updateTrend('testsCompletedTrend', uniqueTests > 0 ? 'up' : '', uniqueTests > 0 ? `+${uniqueTests} this week` : '');
            updateTrend('averageScoreTrend', improvement > 0 ? 'up' : improvement < 0 ? 'down' : '', improvement !== 0 ? `${improvement > 0 ? '+' : ''}${improvement}%` : '');
            updateTrend('bestScoreTrend', bestScore > averageScore ? 'up' : '', bestScore > 0 ? `${bestScore - averageScore > 0 ? '+' : ''}${bestScore - averageScore}% above avg` : '');
            updateTrend('studyStreakTrend', studyStreak > 0 ? 'up' : '', studyStreak > 0 ? 'Keep it up!' : '');
            
            // Update mini stats
            const totalTime = userTestAttempts.reduce((sum, attempt) => sum + (attempt.time_spent || 0), 0);
            const accuracy = completedTests > 0 ? Math.round((userTestAttempts.reduce((sum, attempt) => sum + (attempt.correct_answers || 0), 0) / userTestAttempts.reduce((sum, attempt) => sum + (attempt.total_questions || 42), 0)) * 100) : 0;
            
            document.getElementById('totalTime').textContent = `${Math.round(totalTime / 3600)}h`;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('improvement').textContent = improvement > 0 ? `+${improvement}%` : improvement < 0 ? `${improvement}%` : '0%';
            
            // Update next goal
            const nextTestId = Math.max(1, uniqueTests + 1);
            document.getElementById('nextGoal').textContent = nextTestId <= 10 ? `Test ${nextTestId}` : 'Complete!';

            // Update performance chart
            updatePerformanceChart();
        }

        function updateTrend(elementId, direction, text) {
            const element = document.getElementById(elementId);
            element.className = `progress-trend trend-${direction}`;
            element.textContent = text;
        }

        function updatePerformanceChart() {
            if (userTestAttempts.length === 0) {
                return; // Keep placeholder
            }

            const container = document.getElementById('performanceChartContainer');
            
            // Group attempts by test_id and get best score for each
            const testScores = {};
            userTestAttempts.forEach(attempt => {
                // Ensure score is properly converted to number
                let score = attempt.score;
                if (typeof score === 'string') {
                    score = score.replace('%', '');
                    score = parseFloat(score);
                } else {
                    score = Number(score);
                }
                if (isNaN(score)) score = 0;
                
                if (!testScores[attempt.test_id] || testScores[attempt.test_id] < score) {
                    testScores[attempt.test_id] = score;
                }
            });

            const scores = Object.values(testScores);
            const testNumbers = Object.keys(testScores).sort((a, b) => a - b);

            if (scores.length < 2) {
                // Show single score with enhanced styling
                container.innerHTML = `
                    <div class="chart-placeholder">
                        <div style="background: linear-gradient(135deg, var(--success-color), #38a169); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: white; font-size: 1.5rem; font-weight: 700;">
                            ${Math.round(scores[0])}%
                        </div>
                        <div class="h5 text-success">${Math.round(scores[0])}%</div>
                        <div class="text-muted">Your Score on Test ${testNumbers[0]}</div>
                        <div class="mt-3">
                            <span class="badge bg-success">Great start!</span>
                        </div>
                    </div>
                `;
                return;
            }

            // Create enhanced interactive chart for multiple tests
            const width = 300;
            const height = 200;
            const padding = 50;
            const maxScore = Math.max(...scores, 100);
            const minScore = Math.max(0, Math.min(...scores) - 10);

            // Calculate improvement
            const firstScore = scores[0];
            const latestScore = scores[scores.length - 1];
            const bestScore = Math.max(...scores);
            const averageScore = Math.round(scores.reduce((a, b) => a + b) / scores.length);
            const improvement = Math.round(((bestScore - firstScore) / firstScore) * 100);

            let chartHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                    <svg class="performance-chart-real" viewBox="0 0 ${width} ${height}" style="width: 100%; height: 250px;">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--secondary-color);stop-opacity:0.4" />
                                <stop offset="100%" style="stop-color:var(--secondary-color);stop-opacity:0.1" />
                            </linearGradient>
                            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.3)"/>
                            </filter>
                        </defs>
                        
                        <!-- Grid lines -->
                        <g class="grid" opacity="0.3">
                            <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#e2e8f0" stroke-width="1"/>
                            <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#e2e8f0" stroke-width="1"/>
                            
                            <!-- Horizontal grid lines -->
                            ${[25, 50, 75, 100].map(percent => {
                                const y = height - padding - ((percent - minScore) * (height - 2 * padding)) / (maxScore - minScore);
                                return `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e2e8f0" stroke-width="1" opacity="0.5"/>`;
                            }).join('')}
                        </g>
                        
                        <!-- Y-axis labels -->
                        ${[0, 25, 50, 75, 100].map(percent => {
                            const y = height - padding - ((percent - minScore) * (height - 2 * padding)) / (maxScore - minScore);
                            return `<text x="${padding - 10}" y="${y + 5}" class="chart-label" text-anchor="end" fill="var(--text-light)" font-size="11">${percent}%</text>`;
                        }).join('')}
            `;

            // Create points and lines
            const points = scores.map((score, index) => {
                const x = padding + (index * (width - 2 * padding)) / (scores.length - 1);
                const y = height - padding - ((score - minScore) * (height - 2 * padding)) / (maxScore - minScore);
                return { x, y, score, test: testNumbers[index] };
            });

            // Draw area under curve
            let areaPath = `M ${points[0].x} ${height - padding}`;
            points.forEach(point => {
                areaPath += ` L ${point.x} ${point.y}`;
            });
            areaPath += ` L ${points[points.length - 1].x} ${height - padding} Z`;
            
            chartHTML += `<path d="${areaPath}" fill="url(#gradient)"/>`;

            // Draw smooth connecting line
            let linePath = `M ${points[0].x} ${points[0].y}`;
            for (let i = 1; i < points.length; i++) {
                const cp1x = points[i - 1].x + (points[i].x - points[i - 1].x) / 3;
                const cp1y = points[i - 1].y;
                const cp2x = points[i].x - (points[i].x - points[i - 1].x) / 3;
                const cp2y = points[i].y;
                linePath += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${points[i].x} ${points[i].y}`;
            }
            chartHTML += `<path d="${linePath}" stroke="var(--secondary-color)" stroke-width="3" fill="none" stroke-linecap="round"/>`;

            // Draw enhanced points with hover effects
            points.forEach((point, index) => {
                const isHighest = point.score === bestScore;
                const pointColor = isHighest ? 'var(--accent-gold)' : 'var(--secondary-color)';
                chartHTML += `
                    <circle cx="${point.x}" cy="${point.y}" r="6" fill="${pointColor}" stroke="white" stroke-width="3" 
                            style="cursor: pointer; transition: all 0.3s ease; filter: url(#shadow)" 
                            onmouseover="this.setAttribute('r', '8'); showTooltip(event, 'Test ${point.test}: ${Math.round(point.score)}%')"
                            onmouseout="this.setAttribute('r', '6'); hideTooltip()"
                            onclick="highlightTest(${point.test})"/>
                `;
            });

            // X-axis labels
            points.forEach(point => {
                chartHTML += `<text x="${point.x}" y="${height - padding + 20}" class="chart-label" text-anchor="middle" fill="var(--text-light)" font-size="12">Test ${point.test}</text>`;
            });

            chartHTML += `</svg>`;

            // Add summary statistics below chart
            chartHTML += `
                <div style="margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-color);">${averageScore}%</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Average Score</div>
                        </div>
                        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--success-color);">${Math.round(bestScore)}%</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Best Score</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e6f3ff, #f0f8ff); border-left: 4px solid ${improvement > 0 ? 'var(--success-color)' : improvement < 0 ? 'var(--danger-color)' : 'var(--warning-color)'}; padding: 12px; border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 3px;">
                            ${improvement > 0 ? ' Improving Trend' : improvement < 0 ? ' Focus Needed' : ' Consistent Performance'}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-light);">
                            ${improvement > 0 ? `+${improvement}% improvement from first to best score` : 
                              improvement < 0 ? `${improvement}% change - review weak areas` : 
                              'Maintaining steady performance across tests'}
                        </div>
                    </div>
                </div>
                
                <!-- Tooltip element -->
                <div id="chartTooltip" style="position: absolute; background: var(--primary-color); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; z-index: 1000;"></div>
            </div>
            `;

            container.innerHTML = chartHTML;

            // Add tooltip functionality
            window.showTooltip = function(event, text) {
                const tooltip = document.getElementById('chartTooltip');
                tooltip.textContent = text;
                tooltip.style.opacity = '1';
                const rect = container.getBoundingClientRect();
                tooltip.style.left = (event.clientX - rect.left + 10) + 'px';
                tooltip.style.top = (event.clientY - rect.top - 30) + 'px';
            };

            window.hideTooltip = function() {
                const tooltip = document.getElementById('chartTooltip');
                tooltip.style.opacity = '0';
            };

            window.highlightTest = function(testId) {
                console.log(`Highlighting test ${testId} - could navigate to test details`);
            };
        }
        
        // Update recent activity with real data
        function updateRecentActivity() {
            const activityContainer = document.getElementById('recentActivity');
            let activityHTML = '';

            // Sort attempts by date
            const sortedAttempts = [...userTestAttempts].sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

            sortedAttempts.slice(0, 5).forEach(attempt => {
                // Ensure score is properly converted to number
                let score = attempt.score;
                if (typeof score === 'string') {
                    score = score.replace('%', '');
                    score = parseFloat(score);
                } else {
                    score = Number(score);
                }
                if (isNaN(score)) score = 0;
                
                const isGoodScore = score >= 70;
                const isGreatScore = score >= 85;
                
                activityHTML += `
                    <div class="activity-item">
                        <div class="activity-icon ${isGreatScore ? 'activity-improvement' : 'activity-completed'}">
                            <i class="fas fa-${isGreatScore ? 'star' : 'check'}"></i>
                        </div>
                        <div class="activity-info">
                            <div class="activity-title">Completed Practice Test ${attempt.test_id}</div>
                            <div class="activity-time">${formatDate(attempt.completed_at)}</div>
                        </div>
                        <div class="activity-score">${Math.round(score)}%</div>
                    </div>
                `;
            });

            if (activityHTML === '') {
                activityHTML = `
                    <div class="activity-item">
                        <div class="activity-icon activity-started">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-info">
                            <div class="activity-title">Joined Lexcello</div>
                            <div class="activity-time">Welcome to your LNAT prep!</div>
                        </div>
                    </div>
                `;
            }

            activityContainer.innerHTML = activityHTML;
        }

        // Generate achievements based on user progress
        function generateAchievements() {
            const achievementsContainer = document.getElementById('achievementsContainer');
            const completedTests = [...new Set(userTestAttempts.map(a => a.test_id))].length;
            
            // Ensure best score calculation uses proper number conversion
            let bestScore = 0;
            if (userTestAttempts.length > 0) {
                const validScores = userTestAttempts.map(a => {
                    let score = a.score;
                    if (typeof score === 'string') score = parseFloat(score.replace('%', ''));
                    return Number(score) || 0;
                });
                bestScore = Math.max(...validScores);
            }
            
            const totalAttempts = userTestAttempts.length;
            
            let achievementsHTML = '';

            // Welcome achievement
            achievementsHTML += `
                <div class="achievement-badge">
                    <i class="fas fa-star"></i>
                    Welcome!
                </div>
            `;

            // Test completion achievements
            if (completedTests >= 1) {
                achievementsHTML += `
                    <div class="achievement-badge">
                        <i class="fas fa-play"></i>
                        First Test
                    </div>
                `;
            }

            if (completedTests >= 3) {
                achievementsHTML += `
                    <div class="achievement-badge gold">
                        <i class="fas fa-medal"></i>
                        3 Tests Done
                    </div>
                `;
            }

            if (completedTests >= 5) {
                achievementsHTML += `
                    <div class="achievement-badge gold">
                        <i class="fas fa-trophy"></i>
                        Halfway There
                    </div>
                `;
            }

            // Score achievements
            if (bestScore >= 70) {
                achievementsHTML += `
                    <div class="achievement-badge">
                        <i class="fas fa-thumbs-up"></i>
                        70%+ Score
                    </div>
                `;
            }

            if (bestScore >= 85) {
                achievementsHTML += `
                    <div class="achievement-badge gold">
                        <i class="fas fa-star"></i>
                        85%+ Score
                    </div>
                `;
            }

            // Persistence achievements
            if (totalAttempts >= 5) {
                achievementsHTML += `
                    <div class="achievement-badge silver">
                        <i class="fas fa-dumbbell"></i>
                        Dedicated
                    </div>
                `;
            }

            achievementsContainer.innerHTML = achievementsHTML;
        }
        
        // Animate numbers counting up
        function animateNumber(elementId, target, suffix = '') {
            const element = document.getElementById(elementId);
            let current = 0;
            const increment = Math.max(1, Math.floor(target / 30));
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    element.textContent = target + suffix;
                    clearInterval(timer);
                } else {
                    element.textContent = current + suffix;
                }
            }, 50);
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Today';
            if (diffDays === 2) return 'Yesterday';
            if (diffDays <= 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }
        
        // Navigation functions with subscription checking
        function startTest(testNumber) {
            // Check if user has access to this test
            if (testNumber > 1 && !userSubscription.isPaid) {
                upgradeToPremium();
                return;
            }

            if (confirm(`Ready to start Practice Test ${testNumber}? This test must be completed in one session and will take approximately 95 minutes.`)) {
                if (testNumber === 1) {
                    window.location.href = 'practice-test-1.html';
                } else {
                    window.location.href = `practice-test-1.html?test=${testNumber}`;
                }
            }
        }

        function viewTestResults(testNumber) {
            // Check if user has access to this test
            if (testNumber > 1 && !userSubscription.isPaid) {
                upgradeToPremium();
                return;
            }

            const testAttempts = userTestAttempts.filter(a => a.test_id === testNumber);
            if (testAttempts.length > 0) {
                // Store the test results in session storage for the results page
                sessionStorage.setItem('testResults', JSON.stringify(testAttempts[testAttempts.length - 1]));
                window.location.href = 'test-results.html';
            }
        }

        function upgradeToPremium() {
            window.location.href = 'pricing.html';
        }

        function showAllTests() {
            // Scroll to tests section
            document.querySelector('.tests-grid').scrollIntoView({ behavior: 'smooth' });
        }
        
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('authToken');
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        function showLoadingError() {
            const container = document.getElementById('testsContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Loading Error:</strong> Unable to connect to the server. Please check your connection and try again.
                    <button class="btn btn-outline-danger btn-sm ms-3" onclick="initializeDashboard()">
                        <i class="fas fa-refresh me-1"></i>Retry
                    </button>
                </div>
            `;
        }
        
        // Error handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Auto-refresh data every 5 minutes
        setInterval(async () => {
            try {
                await checkSubscriptionStatus();
                await loadUserData();
                updateProgressStats();
                updateRecentActivity();
                updateSubscriptionUI();
            } catch (error) {
                console.log('Auto-refresh failed:', error);
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>




