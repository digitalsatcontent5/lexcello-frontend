<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6EV4Y6N8M5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-6EV4Y6N8M5');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Lexcello</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1a365d;
            --primary-hover: #2d4a66;
            --secondary-color: #2b6cb0;
            --accent-gold: #d69e2e;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --bg-light: #f7fafc;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
        }
        
        .payment-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .payment-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .payment-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .payment-body {
            padding: 40px;
        }
        
        .plan-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .plan-card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(43, 108, 176, 0.1);
        }
        
        .plan-card.selected {
            border-color: var(--secondary-color);
            background: rgba(43, 108, 176, 0.05);
        }
        
        .plan-price {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .plan-features li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plan-features li i {
            color: #28a745;
            margin-right: 10px;
        }
        
        .btn-payment {
            background: var(--secondary-color);
            border: none;
            padding: 15px 30px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1.1rem;
        }
        
        .btn-payment:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        
        .btn-payment:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .security-info {
            background: #f8f9fa;
            border-left: 4px solid var(--accent-gold);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .payment-methods {
            text-align: center;
            margin: 20px 0;
        }
        
        .payment-methods img {
            height: 30px;
            margin: 0 10px;
            opacity: 0.7;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-container">
            <div class="payment-card">
                <div class="payment-header">
                    <h1><i class="fas fa-crown me-2"></i>Upgrade to Premium</h1>
                    <p class="mb-0">Unlock all 10 LNAT practice tests with detailed analytics</p>
                </div>
                
                <div class="payment-body">
                    <div class="error-message" id="error-message"></div>
                    <div class="success-message" id="success-message"></div>
                    
                    <!-- Plan Selection -->
                    <h4 class="mb-4">Choose Your Plan</h4>

                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="plan-card selected" id="main-plan">
                                <div class="text-center mb-3">
                                    <h5>12 Months Premium Access</h5>
                                    <div class="badge bg-success mb-2">Best Value</div>
                                </div>
                                
                                <!-- Currency Display -->
                                <div class="d-flex justify-content-center align-items-center mb-3">
                                    <div class="plan-price" id="display-price">₹9,000</div>
                                </div>
                                
                                <ul class="plan-features">
                                    <li><i class="fas fa-check-circle"></i>All 10 Complete Practice Tests</li>
                                    <li><i class="fas fa-check-circle"></i>Detailed Performance Analytics</li>
                                    <li><i class="fas fa-check-circle"></i>Expert Answer Explanations</li>
                                    <li><i class="fas fa-check-circle"></i>12 Months Full Access</li>
                                    <li><i class="fas fa-check-circle"></i>Unlimited Test Retakes</li>
                                    <li><i class="fas fa-check-circle"></i>Mobile & Desktop Access</li>
                                </ul>
                                
                                <div class="text-center">
                                    <small class="text-muted" id="monthly-rate">₹750 per month</small>
                                </div>
                                
                                <!-- Disclaimer for international currencies -->
                                <div class="text-center mt-3" id="payment-disclaimer" style="display: none;">
                                    <div class="alert alert-warning">
                                        <small>
                                            <i class="fas fa-info-circle"></i>
                                            <strong>Payment Amount:</strong> ₹9,000 INR<br>
                                            (Approximately <span id="approx-amount">$99 USD</span> at current exchange rates)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-payment" id="payment-btn" onclick="initiatePayment()">
                            <i class="fas fa-lock me-2"></i>Proceed to Secure Payment
                        </button>
                    </div>
                    
                    <!-- Security Info -->
                    <div class="security-info">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-shield-alt text-warning me-2"></i>
                            <div>
                                <strong>Secure Payment</strong><br>
                                <small>Your payment is processed securely through PayU, India's leading payment gateway. Your card details are never stored on our servers.</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="payment-methods">
                        <p class="mb-2"><strong>Accepted Payment Methods:</strong></p>
                        <div>
                            <i class="fab fa-cc-visa fa-2x text-primary me-2"></i>
                            <i class="fab fa-cc-mastercard fa-2x text-warning me-2"></i>
                            <i class="fab fa-cc-amex fa-2x text-info me-2"></i>
                            <i class="fas fa-university fa-2x text-success me-2"></i>
                            <i class="fas fa-mobile-alt fa-2x text-secondary"></i>
                        </div>
                        <small class="text-muted">Credit Cards, Debit Cards, Net Banking, UPI & Wallets</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden PayU Form -->
    <form id="payu-form" method="post" style="display: none;">
        <input type="hidden" name="key" id="payu-key">
        <input type="hidden" name="txnid" id="payu-txnid">
        <input type="hidden" name="amount" id="payu-amount">
        <input type="hidden" name="productinfo" id="payu-productinfo">
        <input type="hidden" name="firstname" id="payu-firstname">
        <input type="hidden" name="email" id="payu-email">
        <input type="hidden" name="phone" id="payu-phone">
        <input type="hidden" name="surl" id="payu-surl">
        <input type="hidden" name="furl" id="payu-furl">
        <input type="hidden" name="hash" id="payu-hash">
        <input type="hidden" name="udf1" id="payu-udf1">
        <input type="hidden" name="udf2" id="payu-udf2">
        <input type="hidden" name="udf3" id="payu-udf3">
        <input type="hidden" name="udf4" id="payu-udf4">
        <input type="hidden" name="udf5" id="payu-udf5">
    </form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration
        const API_BASE_URL = 'https://lexcello-backend.onrender.com/api';
        
        // Price configuration
        const prices = {
            INR: { 
                symbol: '₹', 
                amount: 9000, 
                display: '9,000', 
                code: 'INR', 
                monthly: '₹750',
                showDisclaimer: false
            },
            USD: { 
                symbol: '$', 
                amount: 9000,
                display: '99', 
                code: 'INR',
                monthly: '$8.25',
                showDisclaimer: true,
                actualCurrency: 'USD'
            },
            GBP: { 
                symbol: '£', 
                amount: 9000,
                display: '79', 
                code: 'INR',
                monthly: '£6.58',
                showDisclaimer: true,
                actualCurrency: 'GBP'
            }
        };
        
        let selectedPlan = {
            plan: 'premium-12',
            amount: 9000,
            duration: 12,
            currency: 'INR'
        };
        
        // Coupon state
        let appliedCoupon = null;
        let discountAmount = 0;
        let finalAmount = 9000;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSelectedCurrency();
            loadAppliedCoupon();
            checkAuthStatus();
        });
        
        // Load currency selected from pricing page
        function loadSelectedCurrency() {
            const savedCurrency = localStorage.getItem('selectedCurrency') || 'INR';
            
            if (prices[savedCurrency]) {
                selectedPlan.currency = savedCurrency;  // For display only
                selectedPlan.amount = 9000;             // Always start with INR amount
                
                console.log('Loaded currency:', savedCurrency, 'Amount: ₹9000 INR');
                console.log('IMPORTANT: Display currency is', savedCurrency, 'but payment will be processed in INR');
            }
        }
        
        // Load applied coupon from pricing page
        function loadAppliedCoupon() {
            const couponData = localStorage.getItem('appliedCoupon');
            
            if (couponData) {
                try {
                    const coupon = JSON.parse(couponData);
                    appliedCoupon = coupon;
                    discountAmount = coupon.discountAmount;  // INR discount (e.g., 1800)
                    finalAmount = coupon.finalAmount;        // INR final amount (e.g., 7200)
                    
                    // CRITICAL: Update selectedPlan amount to discounted INR amount
                    selectedPlan.amount = finalAmount;
                    
                    console.log('Coupon loaded:', {
                        code: coupon.code,
                        discountINR: discountAmount,
                        finalINR: finalAmount,
                        displayCurrency: selectedPlan.currency
                    });
                    
                    // Update display
                    updatePriceDisplay();
                    
                    // Track coupon usage on payment page
                    try {
                        gtag('event', 'coupon_on_payment_page', {
                            'event_category': 'payment',
                            'event_label': coupon.code,
                            'value': discountAmount
                        });
                    } catch (error) {
                        console.error('GA tracking error:', error);
                    }
                } catch (error) {
                    console.error('Error loading coupon:', error);
                    // If coupon loading fails, reset to full amount
                    finalAmount = 9000;
                    selectedPlan.amount = 9000;
                    updatePriceDisplay();
                }
            } else {
                // No coupon - use full amount
                finalAmount = 9000;
                selectedPlan.amount = 9000;
                updatePriceDisplay();
            }
        }
        
        // Update price display
        function updatePriceDisplay() {
            const price = prices[selectedPlan.currency];
            const priceElement = document.getElementById('display-price');
            const monthlyElement = document.getElementById('monthly-rate');
            const disclaimer = document.getElementById('payment-disclaimer');
            const approxAmount = document.getElementById('approx-amount');
            
            if (appliedCoupon) {
                // Calculate display amounts
                const displayOriginal = parseFloat(price.display.replace(/,/g, ''));
                const displayDiscount = (discountAmount * displayOriginal / 9000).toFixed(2);
                const displayFinal = (displayOriginal - displayDiscount).toFixed(2);
                
                // Format for INR
                const formattedOriginal = selectedPlan.currency === 'INR' 
                    ? displayOriginal.toLocaleString('en-IN')
                    : displayOriginal;
                const formattedFinal = selectedPlan.currency === 'INR' 
                    ? parseFloat(displayFinal).toLocaleString('en-IN')
                    : displayFinal;
                
                // Show discounted price
                priceElement.innerHTML = `
                    <span style="text-decoration: line-through; opacity: 0.5; font-size: 0.6em;">${price.symbol}${formattedOriginal}</span>
                    ${price.symbol}${formattedFinal}
                `;
                
                // Show coupon badge
                showCouponBadge();
                
                // Update disclaimer
                if (price.showDisclaimer) {
                    disclaimer.style.display = 'block';
                    const discountedINR = finalAmount.toLocaleString('en-IN');
                    approxAmount.textContent = `${price.symbol}${formattedFinal}`;
                    disclaimer.innerHTML = `
                        <div class="alert alert-warning">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                <strong>Payment Amount:</strong> ₹${discountedINR} INR<br>
                                (Approximately ${price.symbol}${formattedFinal} at current exchange rates)
                            </small>
                        </div>
                    `;
                }
            } else {
                // No coupon - show normal price
                priceElement.textContent = price.symbol + price.display;
                monthlyElement.textContent = price.monthly + ' per month';
                
                // Show disclaimer for international currencies
                if (price.showDisclaimer) {
                    disclaimer.style.display = 'block';
                    approxAmount.textContent = price.symbol + price.display.replace(',', '');
                } else {
                    disclaimer.style.display = 'none';
                }
            }
        }
        
        // Show coupon badge
        function showCouponBadge() {
            // Check if badge already exists
            if (document.getElementById('coupon-badge')) return;
            
            const planCard = document.getElementById('main-plan');
            const badge = document.createElement('div');
            badge.id = 'coupon-badge';
            badge.className = 'alert alert-success mt-3';
            badge.style.cssText = 'margin: 15px 0; padding: 12px; border-radius: 8px;';
            badge.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #155724;">
                            <i class="fas fa-check-circle"></i> Coupon Applied: ${appliedCoupon.code}
                        </strong>
                        <div style="font-size: 0.9rem; margin-top: 5px;">
                            You save ₹${discountAmount.toLocaleString('en-IN')} INR
                        </div>
                    </div>
                    <button onclick="removeCoupon()" 
                            class="btn btn-sm btn-outline-danger"
                            style="font-size: 0.9rem;">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
            `;
            
            planCard.appendChild(badge);
        }
        
        // Remove coupon
        function removeCoupon() {
            if (!confirm('Remove coupon code? You will be charged the full amount.')) {
                return;
            }
            
            appliedCoupon = null;
            discountAmount = 0;
            finalAmount = 9000;
            selectedPlan.amount = 9000;
            
            // Remove from localStorage
            localStorage.removeItem('appliedCoupon');
            
            // Remove badge
            const badge = document.getElementById('coupon-badge');
            if (badge) {
                badge.remove();
            }
            
            // Update display
            updatePriceDisplay();
            
            // Track removal
            try {
                gtag('event', 'coupon_removed_payment_page', {
                    'event_category': 'payment',
                    'event_label': 'user_removed_coupon'
                });
            } catch (error) {
                console.error('GA tracking error:', error);
            }
        }
        
        // Check if user is authenticated
        async function checkAuthStatus() {
            try {
                gtag('event', 'payment_page_view', {
                    'event_category': 'payment',
                    'event_label': 'landed_on_payment_page',
                    'page_location': window.location.href,
                    'page_path': window.location.pathname,
                    'selected_currency': selectedPlan.currency,
                    'coupon_applied': appliedCoupon ? appliedCoupon.code : 'none'
                });
                console.log('Payment page viewed - Currency:', selectedPlan.currency);
            } catch (error) {
                console.error('Tracking error:', error);
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                showError('Please sign in to access premium features');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const userData = await response.json();
                
                if (userData.subscriptionStatus === 'premium') {
                    showSuccess('You already have premium access!');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Auth check error:', error);
                showError('Authentication failed. Please sign in again.');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        // Initiate payment
        async function initiatePayment() {
            try {
                gtag('event', 'click_payment_button', {
                    'event_category': 'payment',
                    'event_label': 'proceed_to_payment',
                    'plan_type': selectedPlan.plan,
                    'plan_amount': finalAmount,
                    'original_amount': 9000,
                    'discount_amount': discountAmount,
                    'currency': selectedPlan.currency,
                    'coupon_code': appliedCoupon ? appliedCoupon.code : 'none'
                });
                
                console.log('Payment button clicked - Final Amount:', finalAmount);
            } catch (error) {
                console.error('Tracking error:', error);
            }
            
            const paymentBtn = document.getElementById('payment-btn');
            const originalText = paymentBtn.innerHTML;
            
            try {
                paymentBtn.disabled = true;
                paymentBtn.innerHTML = '<div class="loading-spinner"></div>Processing...';
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Please sign in to continue');
                }
                
                try {
                    gtag('event', 'payment_initiation_started', {
                        'event_category': 'payment',
                        'event_label': 'api_request_sent',
                        'currency': 'INR',
                        'final_amount': finalAmount
                    });
                } catch (error) {
                    console.error('Tracking error:', error);
                }
                
                // Validate amount before sending
                if (!finalAmount || finalAmount < 100 || finalAmount > 100000) {
                    throw new Error(`Invalid payment amount: ₹${finalAmount}. Please refresh and try again.`);
                }

                if (appliedCoupon && finalAmount >= 9000) {
                    throw new Error('Coupon discount not applied correctly. Please try again.');
                }

                console.log('✓ Payment validation passed - Amount: ₹' + finalAmount + ' INR');
                
                // Create payment order with coupon data
                const requestBody = {
                    planType: selectedPlan.plan,
                    amount: finalAmount,              // Discounted INR amount
                    planDuration: selectedPlan.duration,
                    currency: 'INR'                   // ALWAYS INR
                };
                
                // Add coupon data if applied
                if (appliedCoupon) {
                    requestBody.couponCode = appliedCoupon.code;
                    requestBody.couponId = appliedCoupon.couponId;
                    requestBody.discountAmount = discountAmount;
                    requestBody.originalAmount = 9000;
                }
                
                // Log the exact request
                console.log('Sending payment request:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(`${API_BASE_URL}/payments/create-order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    
                    try {
                        gtag('event', 'payment_initiation_failed', {
                            'event_category': 'payment',
                            'event_label': 'api_error',
                            'error_message': errorData.error || 'Unknown error'
                        });
                    } catch (error) {
                        console.error('Tracking error:', error);
                    }
                    
                    throw new Error(errorData.error || 'Payment initiation failed');
                }
                
                const paymentData = await response.json();
                
                if (paymentData.success) {
                    try {
                        gtag('event', 'payment_order_created', {
                            'event_category': 'payment',
                            'event_label': 'redirecting_to_payu',
                            'transaction_id': paymentData.paymentData.txnid,
                            'currency': 'INR',
                            'final_amount': finalAmount,
                            'coupon_used': appliedCoupon ? appliedCoupon.code : 'none'
                        });
                    } catch (error) {
                        console.error('Tracking error:', error);
                    }
                    
                    fillPayUForm(paymentData.paymentData);
                    submitPayUForm(paymentData.paymentData.payu_url);
                } else {
                    throw new Error('Payment order creation failed');
                }
                
            } catch (error) {
                console.error('Payment initiation error:', error);
                showError(error.message || 'Payment initiation failed. Please try again.');
                
                try {
                    gtag('event', 'payment_error', {
                        'event_category': 'payment',
                        'event_label': 'exception_caught',
                        'error_message': error.message
                    });
                } catch (trackError) {
                    console.error('Tracking error:', trackError);
                }
            } finally {
                paymentBtn.disabled = false;
                paymentBtn.innerHTML = originalText;
            }
        }
        
        // Fill PayU form with payment data
        function fillPayUForm(paymentData) {
            document.getElementById('payu-key').value = paymentData.key;
            document.getElementById('payu-txnid').value = paymentData.txnid;
            document.getElementById('payu-amount').value = paymentData.amount;
            document.getElementById('payu-productinfo').value = paymentData.productinfo;
            document.getElementById('payu-firstname').value = paymentData.firstname;
            document.getElementById('payu-email').value = paymentData.email;
            document.getElementById('payu-phone').value = paymentData.phone;
            document.getElementById('payu-surl').value = paymentData.surl;
            document.getElementById('payu-furl').value = paymentData.furl;
            document.getElementById('payu-hash').value = paymentData.hash;
            document.getElementById('payu-udf1').value = paymentData.udf1;
            document.getElementById('payu-udf2').value = paymentData.udf2;
            document.getElementById('payu-udf3').value = paymentData.udf3;
            document.getElementById('payu-udf4').value = paymentData.udf4 || '';
            document.getElementById('payu-udf5').value = paymentData.udf5 || '';
        }
        
        // Submit PayU form
        function submitPayUForm(payuUrl) {
            const form = document.getElementById('payu-form');
            form.action = payuUrl;
            form.submit();
        }
        
        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }
    </script>
</body>
</html>
