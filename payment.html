<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6EV4Y6N8M5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-6EV4Y6N8M5');
    </script>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Purchase - Lexcello LNAT</title>
    <meta name="description" content="Secure payment for Lexcello LNAT practice tests. Choose from Foundation, Advanced, or Complete packages.">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1a365d;
            --primary-hover: #2d4a66;
            --secondary-color: #2b6cb0;
            --accent-gold: #d69e2e;
            --text-dark: #1a202c;
            --text-light: #4a5568;
            --bg-light: #f7fafc;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
        }
        
        .payment-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .payment-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .payment-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .payment-header.single-test {
            background: linear-gradient(135deg, var(--accent-gold), #b7791f);
        }

        .payment-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .payment-header p {
            margin: 0;
            opacity: 0.95;
        }
        
        .payment-body {
            padding: 40px;
        }
        
        .plan-card {
            border: 2px solid var(--secondary-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            background: rgba(43, 108, 176, 0.03);
        }

        .plan-card.single-test {
            border-color: var(--accent-gold);
            background: rgba(214, 158, 46, 0.05);
        }

        .package-badge {
            display: inline-block;
            background: var(--accent-gold);
            color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .package-badge.single-test {
            background: linear-gradient(135deg, var(--accent-gold), #b7791f);
            color: white;
        }
        
        .plan-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--secondary-color);
            margin: 15px 0;
        }

        .plan-price.single-test {
            color: var(--accent-gold);
        }

        .price-strike {
            text-decoration: line-through;
            opacity: 0.5;
            font-size: 0.6em;
        }
        
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .plan-features li {
            padding: 8px 0;
            display: flex;
            align-items: center;
        }

        .plan-features li i {
            color: #28a745;
            margin-right: 12px;
            font-size: 1.1rem;
        }
        
        .btn-payment {
            background: var(--secondary-color);
            border: none;
            padding: 18px 40px;
            font-weight: 700;
            border-radius: 10px;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1.2rem;
            color: white;
        }
        
        .btn-payment:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(43, 108, 176, 0.3);
        }
        
        .btn-payment:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-paypal {
            background: #0070ba !important;
        }

        .btn-paypal:hover {
            background: #005a94 !important;
        }

        .btn-single-test {
            background: linear-gradient(135deg, var(--accent-gold), #b7791f) !important;
        }

        .btn-single-test:hover {
            background: linear-gradient(135deg, #b7791f, #975a16) !important;
            box-shadow: 0 8px 25px rgba(214, 158, 46, 0.4);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .security-info {
            background: #f8f9fa;
            border-left: 4px solid var(--accent-gold);
            padding: 20px;
            margin: 25px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .payment-methods {
            text-align: center;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .payment-methods i {
            font-size: 2rem;
            margin: 0 8px;
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .coupon-badge {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .coupon-badge strong {
            color: #155724;
        }

        .currency-disclaimer {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .back-link:hover {
            color: var(--primary-hover);
        }

        @media (max-width: 768px) {
            .payment-container {
                margin: 20px auto;
                padding: 10px;
            }

            .payment-body {
                padding: 20px;
            }

            .plan-price {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-container">
            <a href="pricing.html" class="back-link" id="back-link">
                <i class="fas fa-arrow-left me-2"></i>Back to Pricing
            </a>

            <div class="payment-card">
                <div class="payment-header" id="payment-header">
                    <h1><i class="fas fa-lock me-2"></i>Secure Checkout</h1>
                    <p id="header-subtitle">Complete your purchase to unlock premium LNAT practice tests</p>
                </div>
                
                <div class="payment-body">
                    <div class="error-message" id="error-message"></div>
                    <div class="success-message" id="success-message"></div>
                    
                    <h4 class="mb-4"><i class="fas fa-shopping-cart me-2"></i>Order Summary</h4>

                    <div class="plan-card" id="plan-card">
                        <div class="text-center">
                            <div class="package-badge" id="package-badge">Loading...</div>
                            <h5 id="package-title">Loading Package...</h5>
                            <div id="package-subtitle" class="text-muted mb-3"></div>
                        </div>
                        
                        <div class="text-center">
                            <div class="plan-price" id="display-price">
                                <span id="currency-symbol">‚Çπ</span><span id="price-value">0</span>
                            </div>
                            <small class="text-muted" id="monthly-rate"></small>
                        </div>
                        
                        <ul class="plan-features" id="features-list">
                            <li><i class="fas fa-check-circle"></i>Loading features...</li>
                        </ul>
                        
                        <div id="coupon-badge-container"></div>
                        
                        <div id="currency-disclaimer" class="currency-disclaimer" style="display: none;">
                            <small>
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Payment Amount:</strong> <span id="disclaimer-inr-amount"></span><br>
                                <span id="disclaimer-approx"></span>
                            </small>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-payment" id="payment-btn" onclick="initiatePayment()">
                            <i class="fas fa-lock me-2"></i>Proceed to Secure Payment
                        </button>
                    </div>
                    
                    <div class="security-info">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-shield-alt text-warning me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <strong>Secure Payment</strong><br>
                                <small>Your payment is processed securely through industry-standard encryption. Your card details are never stored on our servers.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-methods">
                        <p class="mb-3"><strong>Accepted Payment Methods:</strong></p>
                        <div class="mb-2">
                            <i class="fab fa-cc-visa text-primary"></i>
                            <i class="fab fa-cc-mastercard text-warning"></i>
                            <i class="fab fa-cc-amex text-info"></i>
                            <i class="fab fa-paypal" style="color: #0070ba;"></i>
                            <i class="fas fa-university text-success"></i>
                            <i class="fas fa-mobile-alt text-secondary"></i>
                        </div>
                        <small class="text-muted">PayPal, Credit/Debit Cards, Net Banking, UPI & Wallets</small>
                    </div>

                    <div class="text-center mt-4">
                        <div class="alert alert-info">
                            <i class="fas fa-shield-alt me-2"></i>
                            <strong>3-Day Money-Back Guarantee</strong><br>
                            <small>Not satisfied? Get a full refund within 3 days, no questions asked.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="payu-form" method="post" style="display: none;">
        <input type="hidden" name="key" id="payu-key">
        <input type="hidden" name="txnid" id="payu-txnid">
        <input type="hidden" name="amount" id="payu-amount">
        <input type="hidden" name="productinfo" id="payu-productinfo">
        <input type="hidden" name="firstname" id="payu-firstname">
        <input type="hidden" name="email" id="payu-email">
        <input type="hidden" name="phone" id="payu-phone">
        <input type="hidden" name="surl" id="payu-surl">
        <input type="hidden" name="furl" id="payu-furl">
        <input type="hidden" name="hash" id="payu-hash">
        <input type="hidden" name="udf1" id="payu-udf1">
        <input type="hidden" name="udf2" id="payu-udf2">
        <input type="hidden" name="udf3" id="payu-udf3">
        <input type="hidden" name="udf4" id="payu-udf4">
        <input type="hidden" name="udf5" id="payu-udf5">
    </form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE_URL = 'https://lexcello-backend.onrender.com/api';
        
        const packages = {
            foundation: {
                name: 'Foundation Package',
                subtitle: 'Tests 1-5',
                badge: 'Foundation',
                features: [
                    '5 Full Practice Tests (210 questions)',
                    'Tests 1-5 with progressive difficulty',
                    'Detailed answer explanations',
                    'Performance analytics dashboard',
                    'Timed practice sessions',
                    'Unlimited retakes',
                    'Mobile & desktop access',
                    '12 months full access'
                ],
                prices: {
                    GBP: { symbol: '¬£', price: 49, actualCharge: 5700 },
                    USD: { symbol: '$', price: 65, actualCharge: 5700 },
                    INR: { symbol: '‚Çπ', price: 5700, actualCharge: 5700 }
                }
            },
            advanced: {
                name: 'Advanced Package',
                subtitle: 'Tests 6-10',
                badge: 'Advanced',
                features: [
                    '5 Advanced Practice Tests (210 questions)',
                    'Tests 6-10 with challenging questions',
                    'Detailed answer explanations',
                    'Performance analytics dashboard',
                    'Timed practice sessions',
                    'Unlimited retakes',
                    'Mobile & desktop access',
                    '12 months full access'
                ],
                prices: {
                    GBP: { symbol: '¬£', price: 59, actualCharge: 6900 },
                    USD: { symbol: '$', price: 78, actualCharge: 6900 },
                    INR: { symbol: '‚Çπ', price: 6900, actualCharge: 6900 }
                }
            },
            complete: {
                name: 'Complete Series',
                subtitle: 'All Tests 1-10',
                badge: '‚≠ê Best Value',
                features: [
                    'All 10 Practice Tests (420 questions)',
                    'Complete test series 1-10',
                    'Foundation to advanced difficulty',
                    'Detailed answer explanations',
                    'Advanced performance analytics',
                    'Score prediction algorithm',
                    'Timed practice sessions',
                    'Unlimited retakes',
                    'Mobile & desktop access',
                    '12 months full access'
                ],
                prices: {
                    GBP: { symbol: '¬£', price: 99, actualCharge: 11500 },
                    USD: { symbol: '$', price: 130, actualCharge: 11500 },
                    INR: { symbol: '‚Çπ', price: 11500, actualCharge: 11500 }
                }
            },
            'single-test': {
                name: 'Single Practice Test',
                subtitle: 'Test #',
                badge: 'üéØ Single Test',
                features: [
                    '1 Full Practice Test (42 questions)',
                    'Detailed answer explanations',
                    'Performance analytics',
                    'Timed practice session',
                    'Unlimited retakes',
                    'Mobile & desktop access',
                    '12 months access'
                ],
                prices: {
                    GBP: { symbol: '¬£', price: 18, actualCharge: 1900 },
                    USD: { symbol: '$', price: 23, actualCharge: 1900 },
                    INR: { symbol: '‚Çπ', price: 1900, actualCharge: 1900 }
                }
            }
        };
        
        let selectedPlan = {
            package: 'complete',
            currency: 'GBP',
            amount: 11500,
            gateway: 'paypal',
            testId: null
        };
        
        let appliedCoupon = null;
        let discountAmount = 0;
        let finalAmount = 11500;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadSelectedPackage();
            loadSelectedCurrency();
            loadAppliedCoupon();
            checkAuthStatus();
        });
        
        function loadSelectedPackage() {
            const savedPackage = localStorage.getItem('selectedPackage') || 'complete';
            const savedTestId = localStorage.getItem('selectedTestId');
            
            console.log('Loading package:', savedPackage, 'TestId:', savedTestId);
            
            if (savedPackage === 'single-test' && savedTestId) {
                selectedPlan.package = 'single-test';
                selectedPlan.testId = parseInt(savedTestId);
                
                packages['single-test'].subtitle = `Test ${savedTestId}`;
                packages['single-test'].name = `Practice Test ${savedTestId}`;
                
                document.getElementById('payment-header').classList.add('single-test');
                document.getElementById('plan-card').classList.add('single-test');
                document.getElementById('back-link').href = 'dashboard.html';
                document.getElementById('back-link').innerHTML = '<i class="fas fa-arrow-left me-2"></i>Back to Dashboard';
                
                updatePackageDisplay();
            } else if (packages[savedPackage]) {
                selectedPlan.package = savedPackage;
                updatePackageDisplay();
            } else {
                selectedPlan.package = 'complete';
                updatePackageDisplay();
            }
        }
        
        function loadSelectedCurrency() {
            const savedCurrency = localStorage.getItem('selectedCurrency') || 'GBP';
            
            if (['GBP', 'USD', 'INR'].includes(savedCurrency)) {
                selectedPlan.currency = savedCurrency;
                selectedPlan.gateway = savedCurrency === 'INR' ? 'payu' : 'paypal';
                updatePriceDisplay();
            }
        }
        
        function loadAppliedCoupon() {
            const couponData = localStorage.getItem('appliedCoupon');
            
            if (couponData) {
                try {
                    const coupon = JSON.parse(couponData);
                    appliedCoupon = coupon;
                    discountAmount = coupon.discountAmount;
                    finalAmount = coupon.finalAmount;
                    selectedPlan.amount = finalAmount;
                    
                    showCouponBadge();
                    updatePriceDisplay();
                } catch (error) {
                    resetToOriginalPrice();
                }
            } else {
                resetToOriginalPrice();
            }
        }

        function resetToOriginalPrice() {
            const pkg = packages[selectedPlan.package];
            const priceData = pkg.prices[selectedPlan.currency];
            finalAmount = priceData.actualCharge;
            selectedPlan.amount = finalAmount;
            updatePriceDisplay();
        }
        
        function updatePackageDisplay() {
            const pkg = packages[selectedPlan.package];
            
            const badgeElement = document.getElementById('package-badge');
            badgeElement.textContent = pkg.badge;
            if (selectedPlan.package === 'single-test') {
                badgeElement.classList.add('single-test');
            }
            
            document.getElementById('package-title').textContent = pkg.name;
            document.getElementById('package-subtitle').textContent = pkg.subtitle;
            
            const featuresList = document.getElementById('features-list');
            featuresList.innerHTML = pkg.features.map(feature => 
                `<li><i class="fas fa-check-circle"></i>${feature}</li>`
            ).join('');
            
            if (selectedPlan.package === 'single-test') {
                document.getElementById('header-subtitle').textContent = 
                    `Purchase Practice Test ${selectedPlan.testId} - Unlock immediately!`;
            } else {
                document.getElementById('header-subtitle').textContent = 
                    `Unlock ${pkg.name} - ${pkg.subtitle}`;
            }
        }
        
        function updatePriceDisplay() {
            const pkg = packages[selectedPlan.package];
            const priceData = pkg.prices[selectedPlan.currency];
            
            document.getElementById('currency-symbol').textContent = priceData.symbol;
            
            const priceElement = document.getElementById('display-price');
            if (selectedPlan.package === 'single-test') {
                priceElement.classList.add('single-test');
            }
            
            if (appliedCoupon) {
                const displayOriginal = priceData.price;
                const displayDiscount = (discountAmount * displayOriginal / priceData.actualCharge).toFixed(2);
                const displayFinal = (displayOriginal - displayDiscount).toFixed(2);
                
                const formattedOriginal = selectedPlan.currency === 'INR' 
                    ? displayOriginal.toLocaleString('en-IN')
                    : displayOriginal;
                const formattedFinal = selectedPlan.currency === 'INR' 
                    ? parseFloat(displayFinal).toLocaleString('en-IN')
                    : displayFinal;
                
                document.getElementById('price-value').innerHTML = 
                    `<span class="price-strike">${formattedOriginal}</span> ${formattedFinal}`;
            } else {
                const formattedPrice = selectedPlan.currency === 'INR' 
                    ? priceData.price.toLocaleString('en-IN')
                    : priceData.price;
                
                document.getElementById('price-value').textContent = formattedPrice;
            }
            
            const monthlyRateElement = document.getElementById('monthly-rate');
            if (selectedPlan.package === 'single-test') {
                monthlyRateElement.textContent = 'One-time payment ‚Ä¢ 12 months access';
            } else {
                const monthlyRate = (priceData.price / 12).toFixed(2);
                monthlyRateElement.textContent = `${priceData.symbol}${monthlyRate} per month`;
            }
            
            document.getElementById('currency-disclaimer').style.display = 'none';
            updatePaymentButton();
        }

        function updatePaymentButton() {
            const paymentBtn = document.getElementById('payment-btn');
            
            if (selectedPlan.package === 'single-test') {
                paymentBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Buy Test Now';
                paymentBtn.classList.add('btn-single-test');
                paymentBtn.classList.remove('btn-paypal');
            } else if (selectedPlan.gateway === 'paypal') {
                paymentBtn.innerHTML = '<i class="fab fa-paypal me-2"></i>Pay with PayPal';
                paymentBtn.classList.add('btn-paypal');
                paymentBtn.classList.remove('btn-single-test');
            } else {
                paymentBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Proceed to Secure Payment';
                paymentBtn.classList.remove('btn-paypal');
                paymentBtn.classList.remove('btn-single-test');
            }
        }
        
        function showCouponBadge() {
            const container = document.getElementById('coupon-badge-container');
            
            let savingsText = '';
            
            if (selectedPlan.currency === 'INR') {
                savingsText = `You save ‚Çπ${discountAmount.toLocaleString('en-IN')} INR`;
            } else {
                const pkg = packages[selectedPlan.package];
                const priceData = pkg.prices[selectedPlan.currency];
                const displayDiscount = (discountAmount * priceData.price / priceData.actualCharge).toFixed(2);
                savingsText = `You save ${priceData.symbol}${displayDiscount} ${selectedPlan.currency}`;
            }
            
            container.innerHTML = `
                <div class="coupon-badge">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>
                                <i class="fas fa-check-circle"></i> Coupon Applied: ${appliedCoupon.code}
                            </strong>
                            <div style="font-size: 0.9rem; margin-top: 5px; color: #155724;">
                                ${savingsText}
                            </div>
                        </div>
                        <button onclick="removeCoupon()" 
                                class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        function removeCoupon() {
            if (!confirm('Remove coupon code? You will be charged the full amount.')) {
                return;
            }
            
            appliedCoupon = null;
            discountAmount = 0;
            localStorage.removeItem('appliedCoupon');
            document.getElementById('coupon-badge-container').innerHTML = '';
            resetToOriginalPrice();
        }
        
        async function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                showError('Please sign in to continue');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const userData = await response.json();
                
                if (selectedPlan.package === 'single-test' && selectedPlan.testId) {
                    const purchasedTests = userData.purchasedTests || [];
                    if (purchasedTests.includes(selectedPlan.testId)) {
                        showSuccess('You already have access to this test!');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                        return;
                    }
                }
                
                if (selectedPlan.package !== 'single-test' && userData.subscriptionStatus === 'premium') {
                    showSuccess('You already have premium access!');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                }
                
            } catch (error) {
                showError('Authentication failed. Please sign in again.');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        async function initiatePayment() {
            if (selectedPlan.gateway === 'paypal') {
                await initiatePayPalPayment();
            } else {
                await initiatePayUPayment();
            }
        }
        
        async function initiatePayPalPayment() {
            const paymentBtn = document.getElementById('payment-btn');
            const originalText = paymentBtn.innerHTML;
            
            try {
                paymentBtn.disabled = true;
                paymentBtn.innerHTML = '<div class="loading-spinner"></div>Processing...';
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Please sign in to continue');
                }
                
                if (!finalAmount || finalAmount < 100 || finalAmount > 100000) {
                    throw new Error(`Invalid payment amount: ‚Çπ${finalAmount}`);
                }
                
                const requestBody = {
                    planType: selectedPlan.package === 'single-test' ? 'single-test' : 'premium-12',
                    amount: finalAmount,
                    planDuration: 12,
                    currency: 'INR',
                    displayCurrency: selectedPlan.currency,
                    packageType: selectedPlan.package === 'single-test' ? 'single-test' : selectedPlan.package
                };
                
                if (selectedPlan.package === 'single-test' && selectedPlan.testId) {
                    requestBody.testId = selectedPlan.testId;
                }
                
                if (appliedCoupon) {
                    requestBody.couponCode = appliedCoupon.code;
                    requestBody.couponId = appliedCoupon.couponId;
                    requestBody.discountAmount = discountAmount;
                    requestBody.originalAmount = packages[selectedPlan.package].prices[selectedPlan.currency].actualCharge;
                }
                
                console.log('PayPal payment request:', requestBody);
                
                const response = await fetch(`${API_BASE_URL}/payments/paypal/create-order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'PayPal payment failed');
                }
                
                const paymentData = await response.json();
                
                if (paymentData.success && paymentData.approvalUrl) {
                    window.location.href = paymentData.approvalUrl;
                } else {
                    throw new Error('PayPal order creation failed');
                }
                
            } catch (error) {
                console.error('PayPal error:', error);
                showError(error.message || 'PayPal payment failed');
            } finally {
                paymentBtn.disabled = false;
                paymentBtn.innerHTML = originalText;
            }
        }
        
        async function initiatePayUPayment() {
            const paymentBtn = document.getElementById('payment-btn');
            const originalText = paymentBtn.innerHTML;
            
            try {
                paymentBtn.disabled = true;
                paymentBtn.innerHTML = '<div class="loading-spinner"></div>Processing...';
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Please sign in to continue');
                }
                
                if (!finalAmount || finalAmount < 100 || finalAmount > 100000) {
                    throw new Error(`Invalid payment amount: ‚Çπ${finalAmount}`);
                }
                
                const requestBody = {
                    planType: selectedPlan.package === 'single-test' ? 'single-test' : 'premium-12',
                    amount: finalAmount,
                    planDuration: 12,
                    currency: 'INR',
                    displayCurrency: selectedPlan.currency,
                    packageType: selectedPlan.package === 'single-test' ? 'single-test' : selectedPlan.package
                };
                
                if (selectedPlan.package === 'single-test' && selectedPlan.testId) {
                    requestBody.testId = selectedPlan.testId;
                }
                
                if (appliedCoupon) {
                    requestBody.couponCode = appliedCoupon.code;
                    requestBody.couponId = appliedCoupon.couponId;
                    requestBody.discountAmount = discountAmount;
                    requestBody.originalAmount = packages[selectedPlan.package].prices.INR.actualCharge;
                }
                
                console.log('PayU payment request:', requestBody);
                
                const response = await fetch(`${API_BASE_URL}/payments/create-order`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Payment failed');
                }
                
                const paymentData = await response.json();
                
                if (paymentData.success) {
                    fillPayUForm(paymentData.paymentData);
                    submitPayUForm(paymentData.paymentData.payu_url);
                } else {
                    throw new Error('Payment order creation failed');
                }
                
            } catch (error) {
                console.error('PayU error:', error);
                showError(error.message || 'Payment failed');
            } finally {
                paymentBtn.disabled = false;
                paymentBtn.innerHTML = originalText;
            }
        }
        
        function fillPayUForm(paymentData) {
            document.getElementById('payu-key').value = paymentData.key;
            document.getElementById('payu-txnid').value = paymentData.txnid;
            document.getElementById('payu-amount').value = paymentData.amount;
            document.getElementById('payu-productinfo').value = paymentData.productinfo;
            document.getElementById('payu-firstname').value = paymentData.firstname;
            document.getElementById('payu-email').value = paymentData.email;
            document.getElementById('payu-phone').value = paymentData.phone;
            document.getElementById('payu-surl').value = paymentData.surl;
            document.getElementById('payu-furl').value = paymentData.furl;
            document.getElementById('payu-hash').value = paymentData.hash;
            document.getElementById('payu-udf1').value = paymentData.udf1;
            document.getElementById('payu-udf2').value = paymentData.udf2;
            document.getElementById('payu-udf3').value = paymentData.udf3;
            document.getElementById('payu-udf4').value = paymentData.udf4 || '';
            document.getElementById('payu-udf5').value = paymentData.udf5 || '';
        }
        
        function submitPayUForm(payuUrl) {
            const form = document.getElementById('payu-form');
            form.action = payuUrl;
            form.submit();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }
    </script>
</body>
</html>
